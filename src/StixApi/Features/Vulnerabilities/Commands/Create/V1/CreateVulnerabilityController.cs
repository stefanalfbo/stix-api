using MediatR;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Swashbuckle.AspNetCore.Annotations;

namespace StixApi.Features.Vulnerabilities.Commands.Create.V1;

[ApiController]
[Route("v1/api/vulnerabilities")]
[Produces("application/json")]
public class CreateVulnerabilityController : ControllerBase
{
    private readonly IMediator _mediator;
    private readonly ILogger<CreateVulnerabilityController> _logger;

    public CreateVulnerabilityController(IMediator mediator, ILogger<CreateVulnerabilityController> logger)
    {
        _mediator = mediator;
        _logger = logger;
    }

    /// <summary>
    /// This endpoint should create a new vulnerability using the STIX II vulnerability model.
    /// </summary>
    /// <remarks>
    /// A Vulnerability is a mistake in software that can be directly used by a hacker to gain access to a system or network.
    /// </remarks>`
    /// <param name="createVulnerabilityCommand"></param>
    /// <returns>The id of the newly created vulnerability</returns>
    [HttpPost]
    [SwaggerOperation(Tags = new[] { "vulnerabilities" })]
    [Authorize(Policy = "create:vuln")]
    public async Task<ActionResult<int>> Post([FromBody] CreateVulnerabilityCommand createVulnerabilityCommand)
    {
        _logger.LogInformation("Creating a new vulnerability.");
        var id = await _mediator.Send(createVulnerabilityCommand);

        return Ok(id);
    }
}
