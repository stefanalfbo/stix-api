using System.Net;
using System.Text.Json;
using Shouldly;
using StixApi.IntegrationTests.Fixtures;

namespace StixApi.IntegrationTests;

public class VulnerabilityControllerTests : IntegrationTest
{
    public VulnerabilityControllerTests(StixApiWebApplicationFactory fixture)
        : base(fixture)
    {
    }

    [Fact]
    public async Task Get_All_Vulnerabilities()
    {
        // Act
        var response = await _client.GetAsync("/v1/api/vulnerabilities");

        // Assert
        response.StatusCode.ShouldBe(HttpStatusCode.OK);
    }

    [Fact]
    public async Task Get_Vulnerability_By_Invalid_Id()
    {
        // Arrange
        var expectedErrorMessage = "Id must follow the pattern: vulnerability--GUID";
        var id = "invalid-id";

        // Act
        var response = await _client.GetAsync($"/v1/api/vulnerabilities/{id}");
        var content = await response.Content.ReadAsStringAsync();

        // Assert
        response.StatusCode.ShouldBe(HttpStatusCode.BadRequest);
        JsonSerializer
            .Deserialize<List<string>>(content)
            .ShouldBe(new List<string>() { expectedErrorMessage });

    }
}
