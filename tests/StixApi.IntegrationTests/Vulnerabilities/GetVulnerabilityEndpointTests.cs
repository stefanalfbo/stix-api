using System.Net;
using System.Text.Json;
using Shouldly;
using StixApi.IntegrationTests.Fixtures;

namespace StixApi.IntegrationTests.Vulnerabilities;

public class VulnerabilityControllerTests : IntegrationTest
{
    public VulnerabilityControllerTests(StixApiWebApplicationFactory fixture)
        : base(fixture)
    {
    }

    [Fact]
    public async Task Get_Vulnerability_By_Invalid_Id()
    {
        // Arrange
        var expectedErrorMessage = "Id must follow the pattern: vulnerability--GUID";
        var id = "invalid-id";

        // Act
        var response = await _client.GetAsync($"/v1/api/vulnerabilities/{id}");
        var content = await response.Content.ReadAsStringAsync();

        // Assert
        response.StatusCode.ShouldBe(HttpStatusCode.BadRequest);
        JsonSerializer
            .Deserialize<List<string>>(content)
            .ShouldBe(new List<string>() { expectedErrorMessage });
    }

    [Fact]
    public async Task Get_Vulnerability_By_Id_That_Do_Not_Exist()
    {
        // Arrange
        var id = "vulnerability--e9eb06c9-ebc1-47a6-a009-4702bd9f744c";

        // Act
        var response = await _client.GetAsync($"/v1/api/vulnerabilities/{id}");

        // Assert
        response.StatusCode.ShouldBe(HttpStatusCode.NotFound);
    }
}
